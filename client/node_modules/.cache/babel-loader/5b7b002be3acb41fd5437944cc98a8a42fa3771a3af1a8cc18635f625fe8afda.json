{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { bin as d3Bin, group, thresholdScott, extent } from '@antv/vendor/d3-array';\nimport { defined, subObject } from '../utils/helper';\nimport { GroupN } from './groupN';\nimport { columnOf } from './utils/helper';\nconst THRESHOLD = 'thresholds';\n/**\n * @see https://github.com/observablehq/plot/blob/main/src/transforms/bin.js\n */\nfunction thresholdAuto(values) {\n  const [min, max] = extent(values);\n  return Math.min(200, thresholdScott(values, min, max));\n}\n/**\n * The Bin aggregate data.\n * @todo More threshold method.\n * @todo Performance.\n */\nexport const Bin = function () {\n  let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  const {\n      groupChannels = ['color'],\n      binChannels = ['x', 'y']\n    } = options,\n    rest = __rest(options, [\"groupChannels\", \"binChannels\"]);\n  const channelIndexKey = {};\n  // Group indexes and update channelIndexKey.\n  const groupBy = (I, mark) => {\n    const {\n      encode\n    } = mark;\n    const binValues = binChannels.map(channel => {\n      const [V] = columnOf(encode, channel);\n      return V;\n    });\n    const thresholds = subObject(rest, THRESHOLD);\n    const DI = I.filter(i => binValues.every(V => defined(V[i])));\n    // Group indexes by both discrete and quantitative channels.\n    const groupKeys = [\n    // For discrete channels, use value as group key.\n    ...groupChannels.map(d => {\n      const [V] = columnOf(encode, d);\n      return V;\n    }).filter(defined).map(V => i => V[i]),\n    // For quantitative channels, use extent of bin as group key.\n    ...binChannels.map((d, i) => {\n      const V = binValues[i];\n      const t = thresholds[d] || thresholdAuto(V);\n      const bins = d3Bin().thresholds(t).value(i => +V[i])(DI);\n      const indexKey = new Map(bins.flatMap(bin => {\n        const {\n          x0,\n          x1\n        } = bin;\n        const key = `${x0},${x1}`;\n        return bin.map(i => [i, key]);\n      }));\n      channelIndexKey[d] = indexKey;\n      return i => indexKey.get(i);\n    })];\n    // Group by indexes by channel keys.\n    const key = i => groupKeys.map(key => key(i)).join('-');\n    return Array.from(group(DI, key).values());\n  };\n  return GroupN(Object.assign(Object.assign(Object.assign({}, Object.fromEntries(Object.entries(rest).filter(_ref => {\n    let [k] = _ref;\n    return !k.startsWith(THRESHOLD);\n  }))), Object.fromEntries(binChannels.flatMap(channel => {\n    const start = _ref2 => {\n      let [i] = _ref2;\n      return +channelIndexKey[channel].get(i).split(',')[0];\n    };\n    const end = _ref3 => {\n      let [i] = _ref3;\n      return +channelIndexKey[channel].get(i).split(',')[1];\n    };\n    end.from = channel;\n    return [[channel, start], [`${channel}1`, end]];\n  }))), {\n    groupBy\n  }));\n};\nBin.props = {};","map":{"version":3,"names":["bin","d3Bin","group","thresholdScott","extent","defined","subObject","GroupN","columnOf","THRESHOLD","thresholdAuto","values","min","max","Math","Bin","options","arguments","length","undefined","groupChannels","binChannels","rest","__rest","channelIndexKey","groupBy","I","mark","encode","binValues","map","channel","V","thresholds","DI","filter","i","every","groupKeys","d","t","bins","value","indexKey","Map","flatMap","x0","x1","key","get","join","Array","from","Object","assign","fromEntries","entries","_ref","k","startsWith","start","_ref2","split","end","_ref3","props"],"sources":["transform/bin.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}